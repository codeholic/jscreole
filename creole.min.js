/*!
 * Copyright (c) 2011 Ivan Fomichev
 * http://github.com/codeholic/jscreole
 * Licensed under MIT license, see http://www.opensource.org/licenses/mit-license.php
 */
var creole=function(e){var r={};r._link="[^\\]|~\\n]*(?:(?:\\](?!\\])|~.)[^\\]|~\\n]*)*",r._linkText="[^\\]~\\n]*(?:(?:\\](?!\\])|~.)[^\\]~\\n]*)*",r._uriPrefix="\\b(?:(?:https?|ftp)://|mailto:)",r._uri=r._uriPrefix+r._link,r._rawUri=r._uriPrefix+"\\S*[^\\s!\"',.:;?]",r._interwikiLink="[\\w.]+:"+r._link,r._img="\\{\\{((?!\\{)[^|}\\n]*(?:}(?!})[^|}\\n]*)*)"+(e&&e.strict?"":"(?:")+"\\|([^}~\\n]*((}(?!})|~.)[^}~\\n]*)*)"+(e&&e.strict?"":")?")+"}}";var n=function(e,r){return r instanceof Function?r(e):(r=r instanceof Array?r:[r],"undefined"==typeof r[1]&&(r[1]=""),r[0]+e+r[1])},t={_hr:{_tag:"hr",_regex:/(^|\n)\s*----\s*(\n|$)/},_br:{_tag:"br",_regex:/\\\\/},_preBlock:{_tag:"pre",_capture:2,_regex:/(^|\n)\{\{\{\n((.*\n)*?)\}\}\}(\n|$)/,_replaceRegex:/^ ([ \t]*\}\}\})/gm,_replaceString:"$1"},_tt:{_tag:"code",_regex:/\{\{\{(.*?\}\}\}+)/,_capture:1,_replaceRegex:/\}\}\}$/,_replaceString:""},_ulist:{_tag:"ul",_capture:0,_regex:/(^|\n)([ \t]*\*[^*#].*(\n|$)([ \t]*[^\s*#].*(\n|$))*([ \t]*[*#]{2}.*(\n|$))*)+/},_olist:{_tag:"ol",_capture:0,_regex:/(^|\n)([ \t]*#[^*#].*(\n|$)([ \t]*[^\s*#].*(\n|$))*([ \t]*[*#]{2}.*(\n|$))*)+/},_li:{_tag:"li",_capture:0,_regex:/[ \t]*([*#]).+(\n[ \t]*[^*#\s].*)*(\n[ \t]*[*#]{2}.+)*/,_replaceRegex:/(^|\n)[ \t]*[*#]/g,_replaceString:"$1"},_table:{_tag:"table",_capture:0,_regex:/(^|\n)(\|.*?[ \t]*(\n|$))+/},_tr:{_tag:"tr",_capture:2,_regex:/(^|\n)(\|.*?)\|?[ \t]*(\n|$)/},_th:{_tag:"th",_regex:/\|+=([^|]*)/,_capture:1},_td:{_tag:"td",_capture:1,_regex:"\\|+([^|~\\[{]*((~(.|(?=\\n)|$)|\\[\\["+r._link+"(\\|"+r._linkText+")?\\]\\]"+(e&&e.strict?"":"|"+r._img)+"|[\\[{])[^|~]*)*)"},_singleLine:{_regex:/.+/,_capture:0},_paragraph:{_tag:"p",_capture:0,_regex:/(^|\n)([ \t]*\S.*(\n|$))+/},_text:{_capture:0,_regex:/(^|\n)([ \t]*[^\s].*(\n|$))+/},_strong:{_tag:"strong",_capture:1,_regex:/\*\*([^*~]*((\*(?!\*)|~(.|(?=\n)|$))[^*~]*)*)(\*\*|\n|$)/},_em:{_tag:"em",_capture:1,_regex:"\\/\\/(((?!"+r._uriPrefix+")[^\\/~])*"+"(("+r._rawUri+"|\\/(?!\\/)|~(.|(?=\\n)|$))"+"((?!"+r._uriPrefix+")[^\\/~])*)*)(\\/\\/|\\n|$)"},_img:{_regex:r._img,_build:function(e,r,n){var t=document.createElement("img");t.src=r[1],t.alt=void 0===r[2]?n&&n.defaultImageText?n.defaultImageText:"":r[2].replace(/~(.)/g,"$1"),e.appendChild(t)}},_namedUri:{_regex:"\\[\\[("+r._uri+")\\|("+r._linkText+")\\]\\]",_build:function(e,r,n){var t=document.createElement("a");t.href=r[1],n&&n.isPlainUri?t.appendChild(document.createTextNode(r[2])):this._apply(t,r[2],n),e.appendChild(t)}},_namedLink:{_regex:"\\[\\[("+r._link+")\\|("+r._linkText+")\\]\\]",_build:function(e,r,t){var i=document.createElement("a"),_=r[1].replace(/~(.)/g,"$1").replace(/\s+/g,"_");i.href=t&&t.linkFormat?n(_,t.linkFormat):_,this._apply(i,r[2],t),e.appendChild(i)}},_unnamedUri:{_regex:"\\[\\[("+r._uri+")\\]\\]"},_unnamedLink:{_regex:"\\[\\[("+r._link+")\\]\\]"},_unnamedInterwikiLink:{_regex:"\\[\\[("+r._interwikiLink+")\\]\\]"},_rawUri:{_regex:"("+r._rawUri+")"},_escapedSequence:{_regex:"~("+r._rawUri+"|.)",_capture:1,_tag:"span",_attrs:{"class":"escaped"}},_escapedSymbol:{_regex:/~(.)/,_capture:1,_tag:"span",_attrs:{"class":"escaped"}}};t._unnamedUri._build=t._rawUri._build=function(e,r,n){n||(n={}),n.isPlainUri=!0,t._namedUri._build.call(this,e,Array(r[0],r[1],r[1]),n)},t._unnamedLink._build=function(e,r,n){t._namedLink._build.call(this,e,Array(r[0],r[1],r[1]),n)},t._namedInterwikiLink={_regex:"\\[\\[("+r._interwikiLink+")\\|("+r._linkText+")\\]\\]",_build:function(e,r,i){var _,a,l=document.createElement("a");return i&&i.interwiki&&(_=r[1].match(/(.*?):(.*)/),a=i.interwiki[_[1]]),"undefined"==typeof a?(t._namedLink._apply||(t._namedLink=new this.constructor(t._namedLink)),t._namedLink._build.call(t._namedLink,e,r,i)):(l.href=n(_[2].replace(/~(.)/g,"$1"),a),this._apply(l,r[2],i),e.appendChild(l),void 0)}},t._unnamedInterwikiLink._build=function(e,r,n){t._namedInterwikiLink._build.call(this,e,Array(r[0],r[1],r[1]),n)},t._namedUri._children=t._unnamedUri._children=t._rawUri._children=t._namedLink._children=t._unnamedLink._children=t._namedInterwikiLink._children=t._unnamedInterwikiLink._children=[t._escapedSymbol,t._img];for(var i=1;6>=i;i++)t["h"+i]={_tag:"h"+i,_capture:2,_regex:"(^|\\n)[ \\t]*={"+i+"}[ \\t]*"+"([^\\n=][^~]*?(~(.|(?=\\n)|$))*)[ \\t]*=*\\s*(\\n|$)"};t._ulist._children=t._olist._children=[t._li],t._li._children=[t._ulist,t._olist],t._li._fallback=t._text,t._table._children=[t._tr],t._tr._children=[t._th,t._td],t._td._children=[t._singleLine],t._th._children=[t._singleLine],t.h1._children=t.h2._children=t.h3._children=t.h4._children=t.h5._children=t.h6._children=t._singleLine._children=t._paragraph._children=t._text._children=t._strong._children=t._em._children=[t._escapedSequence,t._strong,t._em,t._br,t._rawUri,t._namedUri,t._namedInterwikiLink,t._namedLink,t._unnamedUri,t._unnamedInterwikiLink,t._unnamedLink,t._tt,t._img],t._root={_children:[t.h1,t.h2,t.h3,t.h4,t.h5,t.h6,t._hr,t._ulist,t._olist,t._preBlock,t._table],_fallback:{_children:[t._paragraph]}},creole._base.call(this,t,e)};creole._base=function(e,r){arguments.length&&(this._grammar=e,this._grammar._root=new this._ruleConstructor(this._grammar._root),this._options=r)},creole._rule=function(e){if(arguments.length){for(var r in e)this[r]=e[r];this._children||(this._children=[])}},creole._base.prototype={_ruleConstructor:null,_grammar:null,_options:null,parse:function(e,r,n){if(n)for(i in this._options)"undefined"==typeof n[i]&&(n[i]=this._options[i]);else n=this._options;r=r.replace(/\r\n?/g,"\n"),this._grammar._root._apply(e,r,n),n&&n.forIE&&(e.innerHTML=e.innerHTML.replace(/\r?\n/g,"\r\n"))}},creole._base.prototype.constructor=creole._base,creole._base.prototype._ruleConstructor=creole._rule,creole._rule.prototype={_match:function(e){return e.match(this._regex)},_build:function(e,r,n){var t;null!==this._capture&&(t=r[this._capture]);var i;if(this._tag?(i=document.createElement(this._tag),e.appendChild(i)):i=e,t&&(this._replaceRegex&&(t=t.replace(this._replaceRegex,this._replaceString)),this._apply(i,t,n)),this._attrs)for(var _ in this._attrs)i.setAttribute(_,this._attrs[_]),n&&n.forIE&&"class"==_&&(i.className=this._attrs[_]);return this},_apply:function(e,r,n){var t=""+r,i=[];for(this._fallback._apply||(this._fallback=new this.constructor(this._fallback));;){for(var _=!1,a=!1,l=0;l<this._children.length&&("undefined"==typeof i[l]&&(this._children[l]._match||(this._children[l]=new this.constructor(this._children[l])),i[l]=this._children[l]._match(t,n)),!i[l]||_&&!(_.index>i[l].index)||(_=i[l],a=this._children[l],0!=_.index));l++);var c=_?_.index:t.length;if(c>0&&this._fallback._apply(e,t.substring(0,c),n),!_)break;a._build||(a=new this.constructor(a)),a._build(e,_,n);var s=_.index+_[0].length;t=t.substring(s);for(var l=0;l<this._children.length;l++)i[l]&&(i[l].index>=s?i[l].index-=s:i[l]=void 0)}return this},_fallback:{_apply:function(e,r,n){n&&n.forIE&&(r=r.replace(/\n/g," \r")),e.appendChild(document.createTextNode(r))}}},creole._rule.prototype.constructor=creole._rule,creole.prototype=new creole._base,creole.prototype.constructor=creole;
